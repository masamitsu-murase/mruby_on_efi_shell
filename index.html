<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="mruby on EFI Shell : mruby porting on EFI Shell" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>mruby on EFI Shell</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/masamitsu-murase/mruby_on_efi_shell">View on GitHub</a>

          <h1 id="project_title">mruby on EFI Shell</h1>
          <h2 id="project_tagline">mruby porting on EFI Shell</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/masamitsu-murase/mruby_on_efi_shell/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/masamitsu-murase/mruby_on_efi_shell/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>Overview</h3>

<p>This is a <a href="https://github.com/mruby/mruby">mruby</a> porting on <a href="http://en.wikipedia.org/wiki/Unified_Extensible_Firmware_Interface">EFI Shell</a>.</p>

<ul>
<li>You can call UEFI functions via wrapper functions of <a href="http://wiki.phoenix.com/wiki/index.php/EFI_BOOT_SERVICES">BootService</a> and <a href="http://wiki.phoenix.com/wiki/index.php/EFI_RUNTIME_SERVICES">RuntimeService</a>.</li>
<li>You can define any native C structure and you can access to the members via the structure.</li>
</ul><h3>How to use</h3>

<ol>
<li>Download UEFI Shell from <a href="http://sourceforge.net/projects/efi-shell/files/Releases/Official%20Releases/">Tiano page</a>.</li>
<li>Put UEFI Shell binary in your USB memory as <code>EFI\BOOT\BOOTX64.efi</code>.</li>
<li>Download <strong>mruby on EFI Shell</strong> from <a href="http://sdrv.ms/Yh4bch">download page</a>.</li>
<li>Extract it and put it in your USB memory.</li>
<li>You can run mruby script as follows:<br><code>
&gt; mruby.efi script.rb
</code>
</li>
</ol><h3>Samples</h3>

<h4>Calling <code>ResetSystem</code> of Runtime Service</h4>

<div class="highlight"><pre><span class="c1"># Shutdown</span>
<span class="c1"># Currently, the name of constants are too long...</span>
<span class="no">UEFI</span><span class="o">::</span><span class="no">RuntimeService</span><span class="o">.</span><span class="n">reset_system</span><span class="p">(</span><span class="no">UEFI</span><span class="o">::</span><span class="no">RuntimeService</span><span class="o">::</span><span class="no">ResetShutdown</span><span class="p">,</span> <span class="no">UEFI</span><span class="o">::</span><span class="no">Status</span><span class="o">::</span><span class="no">SUCCESS</span><span class="p">)</span>
</pre></div>

<h4>Defining and calling UEFI native protocols</h4>

<p>This is an example of reading disk via <a href="http://wiki.phoenix.com/wiki/index.php/EFI_DISK_IO_PROTOCOL"><code>EFI_DISK_IO_PROTOCOL</code></a>.</p>

<p>You can download entire source code from <a href="https://github.com/masamitsu-murase/mruby_on_efi_shell/blob/master/example/read_disk.rb"><code>example/read_disk.rb</code></a>.</p>

<div class="highlight"><pre><span class="c1"># This is a part of the source code.</span>

<span class="c1"># Any native C structure can be defined.</span>
<span class="k">class</span> <span class="nc">DiskIoProtocol</span> <span class="o">&lt;</span> <span class="no">UEFI</span><span class="o">::</span><span class="no">Protocol</span>
  <span class="c1"># DiskIoProtocol: http://wiki.phoenix.com/wiki/index.php/EFI_DISK_IO_PROTOCOL</span>
  <span class="no">GUID</span> <span class="o">=</span> <span class="no">UEFI</span><span class="o">::</span><span class="no">Guid</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"CE345171-BA0B-11d2-8e4F-00a0c969723b"</span><span class="p">)</span>

  <span class="n">define_variable</span><span class="p">(</span><span class="ss">:revision</span><span class="p">,</span> <span class="ss">:u64</span><span class="p">)</span>
  <span class="n">define_function</span><span class="p">(</span><span class="ss">:read_disk</span><span class="p">,</span> <span class="ss">:efi_status</span><span class="p">,</span> <span class="o">[</span><span class="ss">:p</span><span class="p">,</span> <span class="ss">:u32</span><span class="p">,</span> <span class="ss">:u64</span><span class="p">,</span> <span class="ss">:u64</span><span class="p">,</span> <span class="ss">:p</span><span class="o">]</span><span class="p">)</span>
  <span class="c1">#...</span>
<span class="k">end</span>

<span class="c1"># (snip)</span>

<span class="c1"># Now, `handle` contains the Handle of DiskIoProtocol,</span>
<span class="c1"># `media_id` contains ID of the disk.</span>
<span class="nb">puts</span> <span class="s2">"handle: </span><span class="si">#{</span><span class="n">handle</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="s2">"media_id: </span><span class="si">#{</span><span class="n">media_id</span><span class="si">}</span><span class="s2">"</span>

<span class="c1"># Find DiskIoProtocol via HandleProtocol.</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="no">UEFI</span><span class="o">::</span><span class="no">BootService</span><span class="o">.</span><span class="n">handle_protocol</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="no">DiskIoProtocol</span><span class="o">::</span><span class="no">GUID</span><span class="p">)</span>
<span class="n">dp</span> <span class="o">=</span> <span class="no">DiskIoProtocol</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>

<span class="n">buf</span> <span class="o">=</span> <span class="s2">" "</span> <span class="o">*</span> <span class="mi">512</span>  <span class="c1"># Buffer to be filled with returned data.</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">read_disk</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">media_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">success?</span><span class="p">)</span>
  <span class="n">print_binary_data</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="k">else</span>
  <span class="nb">puts</span> <span class="s2">"ERROR: </span><span class="si">#{</span><span class="n">st</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</pre></div>

<p>The result is as follows:<br><img src="images/vmware1.png" alt="Result of DiskIoProtocol"></p>

<h4>Reference</h4>

<p>[T.B.D.]</p>

<h4>License</h4>

<p>Same as mruby, MIT License.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">mruby on EFI Shell maintained by <a href="https://github.com/masamitsu-murase">masamitsu-murase</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("mruby, EFI, UEFI, Shell");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
